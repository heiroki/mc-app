# .github/workflows/build-installer.yml

name: Build Windows Installer

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 手動実行を許可

env:
  APP_NAME: MCApp
  APP_VERSION: 1.0.0
  PYTHON_VERSION: '3.11'
  FLUTTER_VERSION: '3.16.0'
  MODEL_REPO: alfredplpl/gemma-2-2b-jpn-it-gguf
  MODEL_NAME: gemma-2-2b-jpn-it-Q4_K_M.gguf

jobs:
  build-installer:
    runs-on: windows-latest
    
    steps:
    ###########################################
    # 1. リポジトリのチェックアウト
    ###########################################
    - name: Checkout repository
      uses: actions/checkout@v4
    
    ###########################################
    # 2. Python環境のセットアップ
    ###########################################
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        cd backend
        pip install -r requirements.txt
        pip install pyinstaller
    
    ###########################################
    # 3. Flutter環境のセットアップ
    ###########################################
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: Flutter doctor
      run: flutter doctor -v
    
    - name: Enable Windows desktop
      run: flutter config --enable-windows-desktop
    
    ###########################################
    # 4. モデルファイルのダウンロード
    ###########################################
    - name: Cache model file
      id: cache-model
      uses: actions/cache@v3
      with:
        path: models/${{ env.MODEL_NAME }}
        key: model-${{ env.MODEL_NAME }}-v1
    
    - name: Download model file
      if: steps.cache-model.outputs.cache-hit != 'true'
      run: |
        python build/download_model.py
    
    - name: Verify model file
      run: |
        if (Test-Path "models/${{ env.MODEL_NAME }}") {
          $size = (Get-Item "models/${{ env.MODEL_NAME }}").Length / 1GB
          Write-Host "✅ Model file found: $size GB"
        } else {
          Write-Host "❌ Model file not found"
          exit 1
        }
    
    ###########################################
    # 5. Backendのビルド（PyInstaller）
    ###########################################
    - name: Build Backend with PyInstaller
      run: |
        Write-Host "Building Backend..."
        pyinstaller build/backend_server.spec
        
        if (Test-Path "dist/backend_server.exe") {
          $size = (Get-Item "dist/backend_server.exe").Length / 1MB
          Write-Host "✅ Backend built successfully: $size MB"
        } else {
          Write-Host "❌ Backend build failed"
          exit 1
        }
    
    - name: Test Backend executable
      run: |
        Write-Host "Testing Backend..."
        $process = Start-Process -FilePath "dist/backend_server.exe" -ArgumentList "--help" -Wait -NoNewWindow -PassThru
        if ($process.ExitCode -ne 0) {
          Write-Host "⚠️ Backend test returned non-zero exit code"
        }
    
###########################################
    # 6. Frontendのビルド（Flutter）
###########################################
    - name: Get Flutter dependencies
      run: |
        cd frontend
        flutter pub get
    
    - name: Add Windows desktop support
      run: |
        cd frontend
        flutter create --platforms=windows .
    
    - name: Build Flutter Windows app
      run: |
        cd frontend
        flutter build windows --release
    
    - name: Verify Flutter build
      run: |
        cd frontend
        
        $releasePath = "build\windows\x64\runner\Release"
        
        if (Test-Path $releasePath) {
          Write-Host "[OK] Release directory found"
          
          # .exeファイルを検索
          $exeFiles = Get-ChildItem -Path $releasePath -Filter "*.exe" -File
          
          if ($exeFiles.Count -gt 0) {
            Write-Host "[OK] Frontend built successfully"
            Write-Host "Executable: $($exeFiles[0].Name)"
            Write-Host "Size: $([math]::Round($exeFiles[0].Length / 1MB, 2)) MB"
          } else {
            Write-Host "[ERROR] No executable found in $releasePath"
            Get-ChildItem -Path $releasePath
            exit 1
          }
        } else {
          Write-Host "[ERROR] Release directory not found: $releasePath"
          exit 1
        }
    
    ###########################################
    # 7. VC++ Redistributableのダウンロード
    ###########################################
    - name: Download VC++ Redistributable
      run: |
        $vcRedistUrl = "https://aka.ms/vs/17/release/vc_redist.x64.exe"
        $vcRedistPath = "installer/vcredist_x64.exe"
        
        Write-Host "Downloading VC++ Redistributable..."
        Invoke-WebRequest -Uri $vcRedistUrl -OutFile $vcRedistPath
        
        if (Test-Path $vcRedistPath) {
          $size = (Get-Item $vcRedistPath).Length / 1MB
          Write-Host "✅ VC++ Redistributable downloaded: $size MB"
        } else {
          Write-Host "❌ VC++ Redistributable download failed"
          exit 1
        }
    
    ###########################################
    # 8. インストーラーパッケージの準備
    ###########################################
    - name: Prepare installer package
      run: |
        python build/prepare_installer.py
    
    ###########################################
    # 9. Inno Setupのインストール
    ###########################################
    - name: Install Inno Setup
      run: |
        choco install innosetup -y
        
        # パスを追加
        $env:Path += ";C:\Program Files (x86)\Inno Setup 6"
        echo "C:\Program Files (x86)\Inno Setup 6" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    
    ###########################################
    # 10. インストーラーのビルド
    ###########################################
    - name: Build installer with Inno Setup
      run: |
        $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        $issFile = "installer/installer.iss"
        
        Write-Host "Building installer..."
        & $isccPath $issFile
        
        if ($LASTEXITCODE -eq 0) {
          Write-Host "✅ Installer built successfully"
        } else {
          Write-Host "❌ Installer build failed"
          exit 1
        }
    
    - name: Verify installer
      run: |
        $installerPath = "installer/output/${{ env.APP_NAME }}_Setup_v${{ env.APP_VERSION }}.exe"
        
        if (Test-Path $installerPath) {
          $size = (Get-Item $installerPath).Length / 1GB
          Write-Host "✅ Installer created: $size GB"
          Write-Host "Path: $installerPath"
        } else {
          Write-Host "❌ Installer not found"
          Write-Host "Searching for installer files..."
          Get-ChildItem -Path "installer/output" -Recurse
          exit 1
        }
    
    ###########################################
    # 11. 成果物のアップロード
    ###########################################
    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-Setup-v${{ env.APP_VERSION }}
        path: installer/output/${{ env.APP_NAME }}_Setup_v${{ env.APP_VERSION }}.exe
        retention-days: 30
    
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build/*.log
          dist/*.log
        retention-days: 7
        if-no-files-found: ignore
    
    ###########################################
    # 12. Releaseの作成（タグpush時のみ）
    ###########################################
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: installer/output/${{ env.APP_NAME }}_Setup_v${{ env.APP_VERSION }}.exe
        body: |
          ## ${{ env.APP_NAME }} v${{ env.APP_VERSION }}
          
          ### インストール方法
          1. `${{ env.APP_NAME }}_Setup_v${{ env.APP_VERSION }}.exe` をダウンロード
          2. ダブルクリックしてインストール
          3. デスクトップの「${{ env.APP_NAME }}」アイコンから起動
          
          ### システム要件
          - OS: Windows 11 Enterprise 23H2以降
          - CPU: Intel 11th Gen Core以降（AVX2対応）
          - メモリ: 16GB以上
          - ストレージ: 5GB以上の空き容量
          
          ### 変更履歴
          - 初回リリース
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        