# .github/workflows/build-installer.yml

name: Build Windows Installer

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 手動実行を許可

env:
  APP_NAME: MCApp
  APP_VERSION: 1.0.0
  PYTHON_VERSION: '3.11'
  FLUTTER_VERSION: '3.16.0'
  MODEL_NAME: gemma-2-2b-jpn-it-Q4_K_M.gguf
  MODEL_REPO: alfredplpl/gemma-2-2b-jpn-it-gguf

jobs:
  build-installer:
    runs-on: windows-latest
    
    steps:
    ###########################################
    # 1. リポジトリのチェックアウト
    ###########################################
    - name: Checkout repository
      uses: actions/checkout@v4
    
    ###########################################
    # 2. Python環境のセットアップ
    ###########################################
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        cd backend
        pip install -r requirements.txt
        pip install pyinstaller
    
    ###########################################
    # 3. Flutter環境のセットアップ
    ###########################################
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: Flutter doctor
      run: flutter doctor -v
    
    - name: Enable Windows desktop
      run: flutter config --enable-windows-desktop
    
    ###########################################
    # 4. モデルファイルのダウンロード
    ###########################################
    - name: Cache model file
      id: cache-model
      uses: actions/cache@v3
      with:
        path: models/${{ env.MODEL_NAME }}
        key: model-${{ env.MODEL_NAME }}-v1
    
    - name: Download model file
      if: steps.cache-model.outputs.cache-hit != 'true'
      run: |
        python build/download_model.py
    
    - name: Verify model file
      run: |
        if (Test-Path "models/${{ env.MODEL_NAME }}") {
          $size = (Get-Item "models/${{ env.MODEL_NAME }}").Length / 1GB
          Write-Host "[OK] Model file found: $size GB"
        } else {
          Write-Host "[ERROR] Model file not found"
          exit 1
        }
    
    ###########################################
    # 5. Backendのビルド（PyInstaller）
    ###########################################
    - name: Build Backend with PyInstaller
      run: |
        Write-Host "=========================================="
        Write-Host "Building Backend with PyInstaller..."
        Write-Host "=========================================="
        pyinstaller build/backend_server.spec
    
    - name: Verify Backend build
      run: |
        Write-Host "Verifying Backend build..."
        
        $backendDir = "dist\backend_server"
        $backendExe = "$backendDir\backend_server.exe"
        
        if (Test-Path $backendDir) {
          Write-Host "[OK] Backend directory found: $backendDir"
          
          if (Test-Path $backendExe) {
            $size = (Get-Item $backendExe).Length / 1MB
            $fileCount = (Get-ChildItem -Path $backendDir -Recurse -File).Count
            Write-Host "[OK] Backend executable found: $([math]::Round($size, 2)) MB"
            Write-Host "[INFO] Total files in backend directory: $fileCount"
          } else {
            Write-Host "[ERROR] Backend executable not found: $backendExe"
            exit 1
          }
        } else {
          Write-Host "[ERROR] Backend directory not found: $backendDir"
          Write-Host "Checking dist directory..."
          if (Test-Path "dist") {
            Get-ChildItem -Path "dist" -Recurse | Select-Object -First 10
          }
          exit 1
        }
    
    ###########################################
    # 6. Frontendのビルド（Flutter）
    ###########################################
    - name: Get Flutter dependencies
      run: |
        cd frontend
        flutter pub get
    
    - name: Add Windows desktop support
      run: |
        cd frontend
        flutter create --platforms=windows .
    
    - name: Build Flutter Windows app
      run: |
        cd frontend
        flutter build windows --release
    
    - name: Verify Flutter build
      run: |
        cd frontend
        
        $releasePath = "build\windows\x64\runner\Release"
        
        if (Test-Path $releasePath) {
          Write-Host "[OK] Release directory found"
          
          $exeFiles = Get-ChildItem -Path $releasePath -Filter "*.exe" -File
          
          if ($exeFiles.Count -gt 0) {
            Write-Host "[OK] Frontend built successfully"
            Write-Host "     Executable: $($exeFiles[0].Name)"
            Write-Host "     Size: $([math]::Round($exeFiles[0].Length / 1MB, 2)) MB"
          } else {
            Write-Host "[ERROR] No executable found in $releasePath"
            Get-ChildItem -Path $releasePath
            exit 1
          }
        } else {
          Write-Host "[ERROR] Release directory not found: $releasePath"
          exit 1
        }
    
    ###########################################
    # 7. VC++ Redistributableのダウンロード
    ###########################################
    - name: Download VC++ Redistributable
      run: |
        $vcRedistUrl = "https://aka.ms/vs/17/release/vc_redist.x64.exe"
        $vcRedistPath = "installer/VC_redist.x64.exe"
        
        Write-Host "Downloading VC++ Redistributable..."
        Invoke-WebRequest -Uri $vcRedistUrl -OutFile $vcRedistPath
        
        if (Test-Path $vcRedistPath) {
          $size = (Get-Item $vcRedistPath).Length / 1MB
          Write-Host "[OK] VC++ Redistributable downloaded: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "[ERROR] VC++ Redistributable download failed"
          exit 1
        }
    
    ###########################################
    # 8. インストーラーパッケージの準備
    ###########################################
    - name: Prepare installer package
      run: |
        python build/prepare_installer.py
    
    ###########################################
    # 9. Inno Setupのインストール
    ###########################################
    - name: Install Inno Setup
      run: |
        choco install innosetup -y
        
        $env:Path += ";C:\Program Files (x86)\Inno Setup 6"
        echo "C:\Program Files (x86)\Inno Setup 6" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    
    ###########################################
    # 10. インストーラーのビルド
    ###########################################
    - name: Debug - Check installer files
      run: |
        Write-Host "=========================================="
        Write-Host "Checking installer directory contents..."
        Write-Host "=========================================="
        
        if (Test-Path "installer") {
          Get-ChildItem -Path "installer" -Recurse | Select-Object -First 30 | ForEach-Object {
            $type = if ($_.PSIsContainer) { "DIR" } else { "$([math]::Round($_.Length / 1MB, 2)) MB" }
            Write-Host "$($_.FullName) - $type"
          }
        } else {
          Write-Host "[ERROR] installer directory not found"
        }
    
    - name: Build installer with Inno Setup
      run: |
        $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        $issFile = "installer/installer.iss"
        
        Write-Host "Building installer..."
        Write-Host "ISCC Path: $isccPath"
        Write-Host "ISS File: $issFile"
        
        if (-not (Test-Path $issFile)) {
          Write-Host "[ERROR] installer.iss not found at: $issFile"
          exit 1
        }
        
        & $isccPath $issFile
        
        if ($LASTEXITCODE -eq 0) {
          Write-Host "[OK] Installer built successfully"
        } else {
          Write-Host "[ERROR] Installer build failed with exit code: $LASTEXITCODE"
          exit 1
        }
    
    - name: Verify installer
      run: |
        $installerPath = "installer/output/${{ env.APP_NAME }}_Setup_v${{ env.APP_VERSION }}.exe"
        
        if (Test-Path $installerPath) {
          $size = (Get-Item $installerPath).Length / 1GB
          Write-Host "[OK] Installer created: $([math]::Round($size, 2)) GB"
          Write-Host "Path: $installerPath"
        } else {
          Write-Host "[ERROR] Installer not found: $installerPath"
          Write-Host "Searching for installer files..."
          if (Test-Path "installer/output") {
            Get-ChildItem -Path "installer/output" -Recurse
          }
          exit 1
        }
    
    ###########################################
    # 11. 成果物のアップロード
    ###########################################
    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-Setup-v${{ env.APP_VERSION }}
        path: installer/output/
        retention-days: 30
    
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build/*.log
          dist/*.log
        retention-days: 7
        if-no-files-found: ignore
    
    ###########################################
    # 12. Releaseの作成（タグpush時のみ）
    ###########################################
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: installer/output/${{ env.APP_NAME }}_Setup_v${{ env.APP_VERSION }}.exe
        body: |
          ## ${{ env.APP_NAME }} v${{ env.APP_VERSION }}
          
          ### インストール方法
          1. `${{ env.APP_NAME }}_Setup_v${{ env.APP_VERSION }}.exe` をダウンロード
          2. ダブルクリックしてインストール
          3. デスクトップの「${{ env.APP_NAME }}」アイコンから起動
          
          ### システム要件
          - OS: Windows 10/11 (64bit)
          - CPU: Intel Core i5 以降（AVX2対応）
          - メモリ: 8GB以上推奨
          - ストレージ: 5GB以上の空き容量
          
          ### 初回起動について
          初回起動時はAIモデルの読み込みに30秒〜1分程度かかります。
          
          ### トラブルシューティング
          - バックエンドの起動に失敗する場合は、スタートメニューから「ログを収集」を実行し、デスクトップに作成されたログフォルダを確認してください
          - ウイルス対策ソフトがブロックしている場合は、例外設定を行ってください
          
          ### 変更履歴
          - 初回リリース
          - デスクトップアプリ版として完全オフライン動作
          - ローカルAIモデル（Gemma 2 2B）による日本語対応
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}